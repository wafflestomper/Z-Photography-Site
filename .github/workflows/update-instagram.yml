name: Update Instagram Feed

permissions:
  contents: write

on:
  schedule:
    # Runs at 10 AM and 10 PM UTC
    - cron: '0 10,22 * * *'
  # Allows manual triggering from GitHub UI
  workflow_dispatch:

jobs:
  update-feed:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ github.token }}
          fetch-depth: 0
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm ci
          npm run build:v2
          echo "Current directory: $(pwd)"
          ls -la images/instagram/
      
      - name: Update Instagram feed
        run: npm run update-instagram:v2
        env:
          INSTAGRAM_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
      
      - name: Verify update
        run: |
          echo "Directory contents before update:"
          ls -la images/instagram/
          echo "Directory contents after update:"
          ls -la images/instagram/
      
      - name: Commit and push if changed
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m "Update Instagram feed" || exit 0
          git push

      - name: Debug - Check Secrets
        run: |
          echo "Checking if secrets are available..."
          if [ -n "${{ secrets.DREAMHOST_HOST }}" ]; then
            echo "DREAMHOST_HOST is set"
          else
            echo "DREAMHOST_HOST is not set"
          fi
          if [ -n "${{ secrets.DREAMHOST_USERNAME }}" ]; then
            echo "DREAMHOST_USERNAME is set"
          else
            echo "DREAMHOST_USERNAME is not set"
          fi
          if [ -n "${{ secrets.DREAMHOST_SSH_KEY }}" ]; then
            echo "DREAMHOST_SSH_KEY is set"
          else
            echo "DREAMHOST_SSH_KEY is not set"
          fi

      - name: Install SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.DREAMHOST_SSH_KEY }}

      - name: Debug - Check SSH
        run: ssh-add -l

      - name: Deploy to DreamHost
        run: |
          # Create the remote directory structure
          echo "Creating remote directory structure..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.DREAMHOST_USERNAME }}@${{ secrets.DREAMHOST_HOST }} 'mkdir -p ~/zollinhofer.com/images/instagram'
          
          # Show local directory contents
          echo "Local directory contents:"
          ls -la images/instagram/
          
          # Deploy the JSON file
          echo "Deploying data/instagram-v2.json..."
          rsync -avz data/instagram-v2.json ${{ secrets.DREAMHOST_USERNAME }}@${{ secrets.DREAMHOST_HOST }}:~/zollinhofer.com/data/
          
          # Deploy the images
          echo "Deploying images/instagram/..."
          rsync -avz images/instagram/ ${{ secrets.DREAMHOST_USERNAME }}@${{ secrets.DREAMHOST_HOST }}:~/zollinhofer.com/images/instagram/
          
          # Verify the files were uploaded
          echo "Verifying remote files..."
          ssh ${{ secrets.DREAMHOST_USERNAME }}@${{ secrets.DREAMHOST_HOST }} 'ls -la ~/zollinhofer.com/images/instagram/'
